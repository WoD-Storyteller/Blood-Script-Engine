exports.up = async function (knex) {
  await knex.raw("BEGIN;\n\n-- RITUALS (ABSTRACT MECHANICAL RECORDS, NO RULEBOOK PROSE)\nCREATE TABLE rituals (\n  ritual_id UUID PRIMARY KEY,\n  engine_id UUID REFERENCES engines(engine_id) ON DELETE CASCADE,\n  tradition TEXT NOT NULL CHECK (tradition IN ('blood_sorcery', 'oblivion', 'cult', 'hedge')),\n  name TEXT NOT NULL,\n  risk_tier INTEGER NOT NULL CHECK (risk_tier BETWEEN 0 AND 5),\n  requirements JSONB NOT NULL DEFAULT '{}',\n  known_effects JSONB NOT NULL DEFAULT '{}',\n  hidden_costs JSONB NOT NULL DEFAULT '{}',\n  canon canon_status NOT NULL DEFAULT 'provisional',\n  created_at TIMESTAMPTZ NOT NULL DEFAULT now()\n);\n\nCREATE INDEX idx_rituals_engine ON rituals(engine_id);\nCREATE INDEX idx_rituals_tradition ON rituals(tradition);\n\n-- OCCULT DISTURBANCE EVENTS\nCREATE TABLE occult_disturbance (\n  event_id UUID PRIMARY KEY,\n  engine_id UUID REFERENCES engines(engine_id) ON DELETE CASCADE,\n  location_id UUID REFERENCES locations(location_id),\n  source_type TEXT NOT NULL, -- ritual, cult, anomaly\n  source_id UUID,\n  severity TEXT NOT NULL,\n  notes TEXT,\n  created_at TIMESTAMPTZ NOT NULL DEFAULT now()\n);\n\nCREATE INDEX idx_occult_engine ON occult_disturbance(engine_id);\nCREATE INDEX idx_occult_location ON occult_disturbance(location_id);\n\n-- SI CELLS\nCREATE TABLE si_cells (\n  cell_id UUID PRIMARY KEY,\n  engine_id UUID REFERENCES engines(engine_id) ON DELETE CASCADE,\n  name TEXT NOT NULL,\n  jurisdiction_location_id UUID REFERENCES locations(location_id),\n  mandate TEXT,\n  capabilities JSONB NOT NULL DEFAULT '{}',\n  tactics JSONB NOT NULL DEFAULT '{}',\n  escalation_doctrine JSONB NOT NULL DEFAULT '{}',\n  created_at TIMESTAMPTZ NOT NULL DEFAULT now()\n);\n\nCREATE INDEX idx_si_cells_engine ON si_cells(engine_id);\nCREATE INDEX idx_si_cells_jurisdiction ON si_cells(jurisdiction_location_id);\n\n-- SI ATTENTION (PHASED ESCALATION BY LOCATION)\nCREATE TABLE si_attention (\n  engine_id UUID REFERENCES engines(engine_id) ON DELETE CASCADE,\n  location_id UUID REFERENCES locations(location_id) ON DELETE CASCADE,\n  phase INTEGER NOT NULL CHECK (phase BETWEEN 1 AND 6),\n  last_update_reason TEXT,\n  updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),\n  PRIMARY KEY (engine_id, location_id)\n);\n\n-- SI OPERATIONS (RAIDS, SURVEILLANCE, STINGS)\nCREATE TABLE si_operations (\n  operation_id UUID PRIMARY KEY,\n  engine_id UUID REFERENCES engines(engine_id) ON DELETE CASCADE,\n  cell_id UUID REFERENCES si_cells(cell_id) ON DELETE SET NULL,\n  target_location_id UUID REFERENCES locations(location_id),\n  operation_type TEXT NOT NULL,\n  status TEXT NOT NULL CHECK (status IN ('planned', 'active', 'completed', 'aborted')),\n  notes TEXT,\n  started_at TIMESTAMPTZ,\n  ended_at TIMESTAMPTZ,\n  created_at TIMESTAMPTZ NOT NULL DEFAULT now()\n);\n\nCREATE INDEX idx_si_ops_engine ON si_operations(engine_id);\nCREATE INDEX idx_si_ops_status ON si_operations(status);\n\nCOMMIT;\n");
};

exports.down = async function () {
  // no automatic rollback
};
