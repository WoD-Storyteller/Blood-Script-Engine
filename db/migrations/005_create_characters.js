exports.up = async function (knex) {
  await knex.raw("BEGIN;\n\n-- CHARACTERS (VTM CORE)\nCREATE TABLE characters (\n  character_id UUID PRIMARY KEY,\n  engine_id UUID REFERENCES engines(engine_id) ON DELETE CASCADE,\n  user_id UUID REFERENCES users(user_id) ON DELETE SET NULL,\n  name TEXT NOT NULL,\n  clan TEXT NOT NULL,\n  is_thin_blood BOOLEAN NOT NULL DEFAULT false,\n  blood_potency INTEGER NOT NULL CHECK (blood_potency >= 0),\n  humanity INTEGER NOT NULL CHECK (humanity BETWEEN 0 AND 10),\n  hunger INTEGER NOT NULL CHECK (hunger BETWEEN 0 AND 5),\n  willpower_current INTEGER NOT NULL,\n  willpower_max INTEGER NOT NULL,\n  ambition TEXT,\n  desire TEXT,\n  status TEXT NOT NULL DEFAULT 'draft',\n  created_at TIMESTAMPTZ NOT NULL DEFAULT now()\n);\n\nCREATE INDEX idx_characters_engine ON characters(engine_id);\nCREATE INDEX idx_characters_user ON characters(user_id);\n\n-- CHARACTER DISCIPLINES\nCREATE TABLE character_disciplines (\n  engine_id UUID REFERENCES engines(engine_id) ON DELETE CASCADE,\n  character_id UUID REFERENCES characters(character_id) ON DELETE CASCADE,\n  discipline TEXT NOT NULL,\n  dots INTEGER NOT NULL CHECK (dots BETWEEN 0 AND 5),\n  amalgams JSONB NOT NULL DEFAULT '{}',\n  PRIMARY KEY (character_id, discipline)\n);\n\n-- TOUCHSTONES\nCREATE TABLE touchstones (\n  touchstone_id UUID PRIMARY KEY,\n  engine_id UUID REFERENCES engines(engine_id) ON DELETE CASCADE,\n  character_id UUID REFERENCES characters(character_id) ON DELETE CASCADE,\n  name TEXT NOT NULL,\n  tags JSONB NOT NULL DEFAULT '{}',\n  status TEXT NOT NULL CHECK (status IN ('safe', 'threatened', 'lost')),\n  visibility TEXT NOT NULL CHECK (visibility IN ('player', 'st')),\n  created_at TIMESTAMPTZ NOT NULL DEFAULT now()\n);\n\n-- CONVICTIONS\nCREATE TABLE convictions (\n  conviction_id UUID PRIMARY KEY,\n  engine_id UUID REFERENCES engines(engine_id) ON DELETE CASCADE,\n  character_id UUID REFERENCES characters(character_id) ON DELETE CASCADE,\n  text TEXT NOT NULL,\n  created_at TIMESTAMPTZ NOT NULL DEFAULT now()\n);\n\n-- STAINS LEDGER\nCREATE TABLE stains_ledger (\n  entry_id UUID PRIMARY KEY,\n  engine_id UUID REFERENCES engines(engine_id) ON DELETE CASCADE,\n  character_id UUID REFERENCES characters(character_id) ON DELETE CASCADE,\n  amount INTEGER NOT NULL CHECK (amount > 0),\n  reason TEXT NOT NULL,\n  scene_id UUID,\n  created_at TIMESTAMPTZ NOT NULL DEFAULT now()\n);\n\n-- XP LEDGER\nCREATE TABLE xp_ledger (\n  entry_id UUID PRIMARY KEY,\n  engine_id UUID REFERENCES engines(engine_id) ON DELETE CASCADE,\n  character_id UUID REFERENCES characters(character_id) ON DELETE CASCADE,\n  amount INTEGER NOT NULL,\n  reason TEXT NOT NULL,\n  created_by TEXT NOT NULL CHECK (created_by IN ('st_core', 'st_user', 'admin')),\n  created_at TIMESTAMPTZ NOT NULL DEFAULT now()\n);\n\nCOMMIT;\n");
};

exports.down = async function () {
  // no automatic rollback
};
