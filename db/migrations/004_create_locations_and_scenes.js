exports.up = async function (knex) {
  await knex.raw("BEGIN;\n\n-- LOCATIONS (GLOBAL → CITY → DISTRICT → SITE / HAVEN)\nCREATE TABLE locations (\n  location_id UUID PRIMARY KEY,\n  engine_id UUID REFERENCES engines(engine_id) ON DELETE CASCADE,\n  name TEXT NOT NULL,\n  type TEXT NOT NULL, -- city, district, site, haven, domain, etc.\n  parent_location_id UUID REFERENCES locations(location_id),\n  lat DOUBLE PRECISION,\n  lng DOUBLE PRECISION,\n  tags JSONB NOT NULL DEFAULT '{}',\n  canon canon_status NOT NULL DEFAULT 'provisional',\n  created_at TIMESTAMPTZ NOT NULL DEFAULT now()\n);\n\nCREATE INDEX idx_locations_engine ON locations(engine_id);\nCREATE INDEX idx_locations_parent ON locations(parent_location_id);\n\n-- SCENES\nCREATE TABLE scenes (\n  scene_id UUID PRIMARY KEY,\n  engine_id UUID REFERENCES engines(engine_id) ON DELETE CASCADE,\n  channel_id TEXT NOT NULL,\n  category_id TEXT,\n  location_id UUID REFERENCES locations(location_id),\n  title TEXT,\n  state scene_state NOT NULL DEFAULT 'active',\n  tone_tags JSONB NOT NULL DEFAULT '{}',\n  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),\n  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()\n);\n\nCREATE INDEX idx_scenes_engine ON scenes(engine_id);\nCREATE INDEX idx_scenes_location ON scenes(location_id);\nCREATE INDEX idx_scenes_state ON scenes(state);\n\n-- SCENE PARTICIPANTS\nCREATE TABLE scene_participants (\n  engine_id UUID REFERENCES engines(engine_id) ON DELETE CASCADE,\n  scene_id UUID REFERENCES scenes(scene_id) ON DELETE CASCADE,\n  participant_type TEXT NOT NULL, -- character, coterie, npc\n  participant_id UUID NOT NULL,\n  joined_at TIMESTAMPTZ NOT NULL DEFAULT now(),\n  left_at TIMESTAMPTZ,\n  PRIMARY KEY (scene_id, participant_id)\n);\n\n-- PRESENCE (FOR PRESENCE-GATING)\nCREATE TABLE presence (\n  engine_id UUID REFERENCES engines(engine_id) ON DELETE CASCADE,\n  character_id UUID NOT NULL,\n  status TEXT NOT NULL CHECK (status IN ('online', 'afk', 'offline')),\n  last_seen_at TIMESTAMPTZ NOT NULL DEFAULT now(),\n  PRIMARY KEY (engine_id, character_id)\n);\n\nCOMMIT;\n");
};

exports.down = async function () {
  // no automatic rollback
};
