exports.up = async function (knex) {
  await knex.raw("BEGIN;\n\nCREATE TABLE chronicle_arcs (\n  arc_id UUID PRIMARY KEY,\n  engine_id UUID NOT NULL,\n  title TEXT NOT NULL,\n  synopsis TEXT,\n  status TEXT NOT NULL DEFAULT 'planned'\n    CHECK (status IN ('planned','active','completed','cancelled')),\n  created_by_user_id UUID,\n  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),\n  updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),\n  started_at TIMESTAMPTZ,\n  ended_at TIMESTAMPTZ,\n  outcome TEXT,\n  FOREIGN KEY (engine_id) REFERENCES engines(engine_id) ON DELETE CASCADE,\n  FOREIGN KEY (created_by_user_id) REFERENCES users(user_id) ON DELETE SET NULL\n);\n\nCREATE INDEX chronicle_arcs_engine_status_idx ON chronicle_arcs(engine_id, status);\n\nCREATE TABLE story_clocks (\n  clock_id UUID PRIMARY KEY,\n  engine_id UUID NOT NULL,\n  title TEXT NOT NULL,\n  description TEXT,\n  segments INTEGER NOT NULL CHECK (segments > 0),\n  progress INTEGER NOT NULL DEFAULT 0 CHECK (progress >= 0),\n  status TEXT NOT NULL DEFAULT 'active'\n    CHECK (status IN ('active','completed','paused','cancelled')),\n  scope TEXT NOT NULL DEFAULT 'engine'\n    CHECK (scope IN ('engine','domain','coterie','scene')),\n  scope_key TEXT,\n  nightly BOOLEAN NOT NULL DEFAULT false,\n  created_by_user_id UUID,\n  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),\n  updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),\n  completed_at TIMESTAMPTZ,\n  FOREIGN KEY (engine_id) REFERENCES engines(engine_id) ON DELETE CASCADE,\n  FOREIGN KEY (created_by_user_id) REFERENCES users(user_id) ON DELETE SET NULL\n);\n\nCREATE INDEX story_clocks_engine_status_idx ON story_clocks(engine_id, status);\nCREATE INDEX story_clocks_engine_nightly_idx ON story_clocks(engine_id, nightly) WHERE nightly = true;\n\nCREATE TABLE clock_ticks (\n  tick_id UUID PRIMARY KEY,\n  engine_id UUID NOT NULL,\n  clock_id UUID NOT NULL,\n  ticked_by_user_id UUID,\n  amount INTEGER NOT NULL,\n  reason TEXT NOT NULL,\n  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),\n  FOREIGN KEY (engine_id) REFERENCES engines(engine_id) ON DELETE CASCADE,\n  FOREIGN KEY (clock_id) REFERENCES story_clocks(clock_id) ON DELETE CASCADE,\n  FOREIGN KEY (ticked_by_user_id) REFERENCES users(user_id) ON DELETE SET NULL\n);\n\nCREATE INDEX clock_ticks_engine_clock_idx ON clock_ticks(engine_id, clock_id);\n\n-- Optional linking: when clock completes, it can affect an arc (just metadata + ST visible).\nCREATE TABLE arc_clock_links (\n  link_id UUID PRIMARY KEY,\n  engine_id UUID NOT NULL,\n  arc_id UUID NOT NULL,\n  clock_id UUID NOT NULL,\n  on_complete TEXT NOT NULL DEFAULT 'notify',\n  notes TEXT,\n  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),\n  FOREIGN KEY (engine_id) REFERENCES engines(engine_id) ON DELETE CASCADE,\n  FOREIGN KEY (arc_id) REFERENCES chronicle_arcs(arc_id) ON DELETE CASCADE,\n  FOREIGN KEY (clock_id) REFERENCES story_clocks(clock_id) ON DELETE CASCADE,\n  UNIQUE (engine_id, arc_id, clock_id)\n);\n\nCOMMIT;");
};

exports.down = async function () {
  // no automatic rollback
};
