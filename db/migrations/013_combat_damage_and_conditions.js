exports.up = async function (knex) {
  await knex.raw("BEGIN;\n\n-- Tracks ongoing damage without altering core characters table\nCREATE TABLE character_trackers (\n  engine_id UUID NOT NULL,\n  character_id UUID NOT NULL,\n  health_superficial INTEGER NOT NULL DEFAULT 0,\n  health_aggravated INTEGER NOT NULL DEFAULT 0,\n  willpower_superficial INTEGER NOT NULL DEFAULT 0,\n  willpower_aggravated INTEGER NOT NULL DEFAULT 0,\n  last_updated TIMESTAMPTZ NOT NULL DEFAULT now(),\n  PRIMARY KEY (engine_id, character_id),\n  FOREIGN KEY (engine_id) REFERENCES engines(engine_id) ON DELETE CASCADE,\n  FOREIGN KEY (character_id) REFERENCES characters(character_id) ON DELETE CASCADE\n);\n\n-- Conditions (generic, IP-safe)\nCREATE TABLE character_conditions (\n  condition_id UUID PRIMARY KEY,\n  engine_id UUID NOT NULL,\n  character_id UUID NOT NULL,\n  name TEXT NOT NULL,\n  severity TEXT NOT NULL DEFAULT 'minor',\n  source TEXT,\n  scene_id UUID,\n  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),\n  resolved_at TIMESTAMPTZ,\n  FOREIGN KEY (engine_id) REFERENCES engines(engine_id) ON DELETE CASCADE,\n  FOREIGN KEY (character_id) REFERENCES characters(character_id) ON DELETE CASCADE\n);\n\n-- Combat log for audit/debug\nCREATE TABLE combat_log (\n  log_id UUID PRIMARY KEY,\n  engine_id UUID NOT NULL,\n  scene_id UUID NOT NULL,\n  attacker_character_id UUID,\n  defender_character_id UUID,\n  damage INTEGER NOT NULL DEFAULT 0,\n  damage_type TEXT NOT NULL DEFAULT 'superficial',\n  summary TEXT NOT NULL,\n  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),\n  FOREIGN KEY (engine_id) REFERENCES engines(engine_id) ON DELETE CASCADE\n);\n\nCOMMIT;\n");
};

exports.down = async function () {
  // no automatic rollback
};
