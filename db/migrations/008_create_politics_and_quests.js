exports.up = async function (knex) {
  await knex.raw("BEGIN;\n\n-- BOONS (PRESTATION)\nCREATE TABLE boons (\n  boon_id UUID PRIMARY KEY,\n  engine_id UUID REFERENCES engines(engine_id) ON DELETE CASCADE,\n  type boon_type NOT NULL,\n  creditor_type TEXT NOT NULL CHECK (creditor_type IN ('character', 'coterie', 'npc', 'faction')),\n  creditor_id UUID NOT NULL,\n  debtor_type TEXT NOT NULL CHECK (debtor_type IN ('character', 'coterie', 'npc', 'faction')),\n  debtor_id UUID NOT NULL,\n  status boon_status NOT NULL DEFAULT 'owed',\n  visibility TEXT NOT NULL CHECK (visibility IN ('public', 'secret')),\n  notes TEXT,\n  created_at TIMESTAMPTZ NOT NULL DEFAULT now()\n);\n\nCREATE INDEX idx_boons_engine ON boons(engine_id);\nCREATE INDEX idx_boons_creditor ON boons(creditor_type, creditor_id);\nCREATE INDEX idx_boons_debtor ON boons(debtor_type, debtor_id);\nCREATE INDEX idx_boons_status ON boons(status);\n\n-- QUESTS\nCREATE TABLE quests (\n  quest_id UUID PRIMARY KEY,\n  engine_id UUID REFERENCES engines(engine_id) ON DELETE CASCADE,\n  scope TEXT NOT NULL CHECK (scope IN ('character', 'coterie')),\n  owner_id UUID NOT NULL,\n  type TEXT NOT NULL,\n  status quest_status NOT NULL DEFAULT 'active',\n  stakes TEXT,\n  metadata JSONB NOT NULL DEFAULT '{}',\n  created_at TIMESTAMPTZ NOT NULL DEFAULT now()\n);\n\nCREATE INDEX idx_quests_engine ON quests(engine_id);\nCREATE INDEX idx_quests_scope_owner ON quests(scope, owner_id);\nCREATE INDEX idx_quests_status ON quests(status);\n\n-- TITLES / OFFICES (POLITICAL POSITIONS)\nCREATE TABLE status_titles (\n  title_id UUID PRIMARY KEY,\n  engine_id UUID REFERENCES engines(engine_id) ON DELETE CASCADE,\n  name TEXT NOT NULL,\n  issuing_authority TEXT,\n  jurisdiction_location_id UUID REFERENCES locations(location_id),\n  powers JSONB NOT NULL DEFAULT '{}',\n  duties JSONB NOT NULL DEFAULT '{}',\n  risks JSONB NOT NULL DEFAULT '{}',\n  visibility TEXT NOT NULL CHECK (visibility IN ('public', 'whispered', 'secret')),\n  created_at TIMESTAMPTZ NOT NULL DEFAULT now()\n);\n\nCREATE INDEX idx_titles_engine ON status_titles(engine_id);\nCREATE INDEX idx_titles_location ON status_titles(jurisdiction_location_id);\n\n-- TITLE ASSIGNMENTS\nCREATE TABLE title_assignments (\n  engine_id UUID REFERENCES engines(engine_id) ON DELETE CASCADE,\n  assignment_id UUID PRIMARY KEY,\n  title_id UUID REFERENCES status_titles(title_id) ON DELETE CASCADE,\n  holder_type TEXT NOT NULL CHECK (holder_type IN ('character', 'npc')),\n  holder_id UUID NOT NULL,\n  granted_by TEXT,\n  active BOOLEAN NOT NULL DEFAULT true,\n  granted_at TIMESTAMPTZ NOT NULL DEFAULT now(),\n  revoked_at TIMESTAMPTZ\n);\n\nCREATE INDEX idx_title_assignments_engine ON title_assignments(engine_id);\nCREATE INDEX idx_title_assignments_title ON title_assignments(title_id);\nCREATE INDEX idx_title_assignments_holder ON title_assignments(holder_type, holder_id) WHERE active = true;\n\n-- POLITICAL ACTIONS (SCHEMES, PETITIONS, UNDERMINING)\nCREATE TABLE political_actions (\n  action_id UUID PRIMARY KEY,\n  engine_id UUID REFERENCES engines(engine_id) ON DELETE CASCADE,\n  actor_type TEXT NOT NULL CHECK (actor_type IN ('character', 'coterie', 'npc', 'faction')),\n  actor_id UUID NOT NULL,\n  target_type TEXT CHECK (target_type IN ('character', 'coterie', 'npc', 'faction', 'location')),\n  target_id UUID,\n  action_type TEXT NOT NULL,\n  intent TEXT,\n  state TEXT NOT NULL CHECK (state IN ('declared', 'in_progress', 'resolved', 'failed')),\n  scene_id UUID,\n  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),\n  resolved_at TIMESTAMPTZ\n);\n\nCREATE INDEX idx_political_actions_engine ON political_actions(engine_id);\nCREATE INDEX idx_political_actions_actor ON political_actions(actor_type, actor_id);\nCREATE INDEX idx_political_actions_state ON political_actions(state);\n\nCOMMIT;\n");
};

exports.down = async function () {
  // no automatic rollback
};
