exports.up = async function (knex) {
  await knex.raw("BEGIN;\n\nCREATE TABLE factions (\n  faction_id UUID PRIMARY KEY,\n  engine_id UUID NOT NULL,\n  name TEXT NOT NULL,\n  ideology TEXT,\n  disposition JSONB NOT NULL DEFAULT '{}'::jsonb,\n  aggression INTEGER NOT NULL DEFAULT 1,\n  secrecy INTEGER NOT NULL DEFAULT 1,\n  resources INTEGER NOT NULL DEFAULT 1,\n  active BOOLEAN NOT NULL DEFAULT true,\n  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),\n  FOREIGN KEY (engine_id) REFERENCES engines(engine_id) ON DELETE CASCADE\n);\n\nCREATE TABLE npcs (\n  npc_id UUID PRIMARY KEY,\n  engine_id UUID NOT NULL,\n  name TEXT NOT NULL,\n  faction_id UUID,\n  role TEXT,\n  personality JSONB NOT NULL DEFAULT '{}'::jsonb,\n  ambition TEXT,\n  status INTEGER NOT NULL DEFAULT 0,\n  alive BOOLEAN NOT NULL DEFAULT true,\n  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),\n  FOREIGN KEY (engine_id) REFERENCES engines(engine_id) ON DELETE CASCADE,\n  FOREIGN KEY (faction_id) REFERENCES factions(faction_id) ON DELETE SET NULL\n);\n\nCREATE TABLE ai_intents (\n  intent_id UUID PRIMARY KEY,\n  engine_id UUID NOT NULL,\n  actor_type TEXT NOT NULL CHECK (actor_type IN ('npc','faction')),\n  actor_id UUID NOT NULL,\n  intent_type TEXT NOT NULL,\n  payload JSONB NOT NULL,\n  status TEXT NOT NULL DEFAULT 'proposed'\n    CHECK (status IN ('proposed','approved','rejected','executed')),\n  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),\n  executed_at TIMESTAMPTZ,\n  FOREIGN KEY (engine_id) REFERENCES engines(engine_id) ON DELETE CASCADE\n);\n\nCOMMIT;");
};

exports.down = async function () {
  // no automatic rollback
};
