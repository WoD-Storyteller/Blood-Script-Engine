exports.up = async function (knex) {
  await knex.raw("BEGIN;\n\n-- Holdings owned by coteries (fronts, rackets, havens, influence assets)\nCREATE TABLE coterie_holdings (\n  holding_id UUID PRIMARY KEY,\n  engine_id UUID NOT NULL,\n  coterie_id UUID NOT NULL,\n  kind TEXT NOT NULL DEFAULT 'holding',\n  name TEXT NOT NULL,\n  income INTEGER NOT NULL DEFAULT 0, -- abstract income\n  notes TEXT,\n  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),\n  updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),\n  FOREIGN KEY (engine_id) REFERENCES engines(engine_id) ON DELETE CASCADE\n);\n\nCREATE INDEX coterie_holdings_engine_coterie_idx ON coterie_holdings(engine_id, coterie_id);\n\n-- Domain tax rules (domain -> coterie, fixed amount per collection)\nCREATE TABLE domain_tax_rules (\n  rule_id UUID PRIMARY KEY,\n  engine_id UUID NOT NULL,\n  domain_name TEXT NOT NULL,\n  taxed_to_coterie_id UUID NOT NULL,\n  amount INTEGER NOT NULL DEFAULT 1,\n  title TEXT NOT NULL DEFAULT 'Domain Tax',\n  notes TEXT,\n  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),\n  updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),\n  UNIQUE (engine_id, domain_name),\n  FOREIGN KEY (engine_id) REFERENCES engines(engine_id) ON DELETE CASCADE\n);\n\nCREATE INDEX domain_tax_rules_engine_idx ON domain_tax_rules(engine_id);\n\n-- Boon enforcement (deadlines + escalation)\nCREATE TABLE boon_enforcements (\n  enforcement_id UUID PRIMARY KEY,\n  engine_id UUID NOT NULL,\n  boon_id UUID NOT NULL,\n  created_by_user_id UUID NOT NULL,\n  status TEXT NOT NULL DEFAULT 'active' CHECK (status IN ('active','resolved','escalated','cancelled')),\n  due_at TIMESTAMPTZ,\n  notes TEXT,\n  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),\n  updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),\n  FOREIGN KEY (engine_id) REFERENCES engines(engine_id) ON DELETE CASCADE,\n  FOREIGN KEY (boon_id) REFERENCES boons(boon_id) ON DELETE CASCADE,\n  FOREIGN KEY (created_by_user_id) REFERENCES users(user_id) ON DELETE CASCADE\n);\n\nCREATE INDEX boon_enforcements_engine_status_idx ON boon_enforcements(engine_id, status);\n\nCOMMIT;");
};

exports.down = async function () {
  // no automatic rollback
};
