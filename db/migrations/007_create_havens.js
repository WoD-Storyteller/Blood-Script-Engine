exports.up = async function (knex) {
  await knex.raw("BEGIN;\n\n-- HAVENS (PERSONAL OR COTERIE)\nCREATE TABLE havens (\n  haven_id UUID PRIMARY KEY,\n  engine_id UUID REFERENCES engines(engine_id) ON DELETE CASCADE,\n  owner_type TEXT NOT NULL CHECK (owner_type IN ('character', 'coterie')),\n  owner_id UUID NOT NULL,\n  location_id UUID REFERENCES locations(location_id),\n  name TEXT NOT NULL,\n  haven_type TEXT NOT NULL, -- apartment, estate, sewer, mobile, etc.\n  security_level TEXT NOT NULL, -- abstracted state\n  secrecy_level TEXT NOT NULL,\n  comfort_level TEXT NOT NULL,\n  political_exposure TEXT NOT NULL,\n  si_exposure TEXT NOT NULL,\n  occult_resonance TEXT,\n  tags JSONB NOT NULL DEFAULT '{}',\n  status TEXT NOT NULL CHECK (status IN ('secure', 'watched', 'compromised', 'lost', 'destroyed')),\n  created_at TIMESTAMPTZ NOT NULL DEFAULT now()\n);\n\nCREATE INDEX idx_havens_engine ON havens(engine_id);\nCREATE INDEX idx_havens_owner ON havens(owner_type, owner_id);\nCREATE INDEX idx_havens_location ON havens(location_id);\n\n-- HAVEN UPGRADES / CHANGES\nCREATE TABLE haven_upgrades (\n  upgrade_id UUID PRIMARY KEY,\n  engine_id UUID REFERENCES engines(engine_id) ON DELETE CASCADE,\n  haven_id UUID REFERENCES havens(haven_id) ON DELETE CASCADE,\n  upgrade_type TEXT NOT NULL,\n  description TEXT,\n  applied_at TIMESTAMPTZ NOT NULL DEFAULT now()\n);\n\n-- HAVEN EVENTS (THREATS, RAIDS, DISCOVERIES)\nCREATE TABLE haven_events (\n  event_id UUID PRIMARY KEY,\n  engine_id UUID REFERENCES engines(engine_id) ON DELETE CASCADE,\n  haven_id UUID REFERENCES havens(haven_id) ON DELETE CASCADE,\n  event_type TEXT NOT NULL,\n  severity TEXT NOT NULL,\n  resolved BOOLEAN NOT NULL DEFAULT false,\n  created_at TIMESTAMPTZ NOT NULL DEFAULT now()\n);\n\n-- HAVEN EXPOSURE TRACKING\nCREATE TABLE haven_exposure (\n  engine_id UUID REFERENCES engines(engine_id) ON DELETE CASCADE,\n  haven_id UUID REFERENCES havens(haven_id) ON DELETE CASCADE,\n  source TEXT NOT NULL, -- SI, politics, occult, rumor\n  level TEXT NOT NULL,\n  updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),\n  PRIMARY KEY (engine_id, haven_id, source)\n);\n\nCOMMIT;\n");
};

exports.down = async function () {
  // no automatic rollback
};
