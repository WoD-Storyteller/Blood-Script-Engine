exports.up = async function (knex) {
  await knex.raw("BEGIN;\n\n-- COTERIES\nCREATE TABLE coteries (\n  coterie_id UUID PRIMARY KEY,\n  engine_id UUID REFERENCES engines(engine_id) ON DELETE CASCADE,\n  name TEXT NOT NULL,\n  type TEXT NOT NULL,\n  visibility coterie_visibility NOT NULL,\n  status coterie_status NOT NULL DEFAULT 'active',\n  created_at TIMESTAMPTZ NOT NULL DEFAULT now()\n);\n\nCREATE INDEX idx_coteries_engine ON coteries(engine_id);\nCREATE INDEX idx_coteries_status ON coteries(status);\n\n-- COTERIE MEMBERSHIPS\nCREATE TABLE coterie_memberships (\n  engine_id UUID REFERENCES engines(engine_id) ON DELETE CASCADE,\n  coterie_id UUID REFERENCES coteries(coterie_id) ON DELETE CASCADE,\n  character_id UUID REFERENCES characters(character_id) ON DELETE SET NULL,\n  role TEXT NOT NULL CHECK (role IN ('leader', 'officer', 'member')),\n  joined_at TIMESTAMPTZ NOT NULL DEFAULT now(),\n  left_at TIMESTAMPTZ,\n  PRIMARY KEY (coterie_id, character_id)\n);\n\nCREATE INDEX idx_coterie_members_engine ON coterie_memberships(engine_id);\nCREATE INDEX idx_coterie_members_active ON coterie_memberships(coterie_id) WHERE left_at IS NULL;\n\n-- DISCORD BINDINGS (ROLES, CATEGORIES, CHANNELS)\nCREATE TABLE discord_bindings (\n  engine_id UUID REFERENCES engines(engine_id) ON DELETE CASCADE,\n  entity_type TEXT NOT NULL CHECK (entity_type IN ('coterie')),\n  entity_id UUID NOT NULL,\n  discord_role_id TEXT,\n  discord_category_id TEXT,\n  ic_channel_id TEXT,\n  ooc_channel_id TEXT,\n  archived_at TIMESTAMPTZ,\n  PRIMARY KEY (engine_id, entity_type, entity_id)\n);\n\nCOMMIT;\n");
};

exports.down = async function () {
  // no automatic rollback
};
